<html xmlns="http://www.w3.org/1999/xhtml"
  xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui"
  xmlns:pe="http://primefaces.org/ui/extensions"
  xmlns:cc="http://java.sun.com/jsf/composite/composite">
<h:body>
  <ui:composition template="../includes/template/wizard.xhtml">

    <ui:define name="content">
      <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
      <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
      <script>
      var diffOptions = {
        drawFileList: false,
        matching: 'words',
        outputFormat: 'side-by-side',
      }
      function showDiff(id, patch) {
        var diffHtml = Diff2Html.html(patch, diffOptions);
        document.getElementById(id).innerHTML = diffHtml;
      }
      </script>
      
      <div class="p-col" style="width: 100%;">
        <p:growl id="migrateGrowl" for="migrateGrowl" showDetail="true">
          <p:autoUpdate />
        </p:growl>
        <div class="ui-fluid">
          <div class="card card-w-title">
            <h1>
              <i class="si si-navigation-right-circle card-title-icon"></i>Migrate old Axon Ivy Engine
              <a href="#{advisorBean.engineGuideBaseUrl}/tool-reference/migration-wizard.html" target="_blank" rel="noopener noreferrer">
                <i class="si si-question-circle card-title-icon" style="float: right;"></i>
              </a>
            </h1>
            <h:form id="locationForm">
              <p:panelGrid columns="3" layout="grid"
                styleClass="ui-panelgrid-blank"
                columnClasses="ui-grid-col-3, ui-grid-col-6, ui-grid-col-3">
                <p:outputLabel for="oldEngineInput"
                  value="Location of old Engine" />
                <h:panelGroup styleClass="md-inputfield">
                  <p:inputText id="oldEngineInput"
                    requiredMessage="Value is required"
                    value="#{migrationBean.pathToOldEngine}"
                    required="true" />
                  <p:message for="oldEngineInput"
                    id="oldEngineInputMessage" />
                </h:panelGroup>

                <p:commandButton icon="si si-heavy-equipment-hook"
                  value="Load Location" id="checkLocation"
                  actionListener="#{migrationBean.checkOldEngineLocation}"
                  validateClient="true" update="migration, @form" />
              </p:panelGrid>
            </h:form>

            <h:panelGroup layout="block" id="migration">
              <h:form id="form" rendered="#{not empty migrationBean.migrationPath}">
                <p:panelGrid columns="2" layout="grid"
                  styleClass="ui-panelgrid-blank"
                  columnClasses="ui-grid-col-9, ui-grid-col-3">
                  <h3>Migrating: #{migrationBean.migrationPath}</h3>
                  
                  <h:panelGroup layout="block" style="margin: 20px 0;">
                    <p:commandButton id="startMigration" icon="si si-controls-play" value="Start"
                      actionListener="#{migrationBean.execute}"
                      update="migration" onsuccess="PF('migrationPoller').start()"
                      rendered="#{migrationBean.state == 'START'}" />
                    <p:commandButton id="finishMigration" icon="si si-check-1" value="Finish"
                      rendered="#{migrationBean.state == 'FINISHED'}" type="button"
                      onclick="PF('finishWizardModel').show();" />
                    <p:commandButton id="migrationRunning" icon="si si-button-refresh-arrows si-is-spinning"
                      value="Running" disabled="true"
                      rendered="#{migrationBean.state == 'RUNNING'}" />
                    <p:poll interval="1"
                      autoStart="#{migrationBean.state == 'RUNNING' and !migrationBean.runnerPaused}"
                      update="migration" widgetVar="migrationPoller" />
                  </h:panelGroup>
                </p:panelGrid>
                <p:messages id="migrationMessage" for="migrationMessage" showDetail="true" closable="true" />
                <ui:repeat var="task" value="#{migrationBean.tasks}" varStatus="tasksRepeat">
                  <div class="migration-step" style="padding: 0 14px;">
                    <h4 style="margin-top: 2rem; margin-bottom: 0;">
                      <i class="si si-#{task.stateIcon}"
                        style="margin-right: 10px;"></i> #{task.name}
                    </h4>
                    <p style="margin-left: 30px;">#{task.description}</p>
                    <h:panelGroup rendered="#{task.state == 'running'}" layout="block">
                      <p:repeat var="question" value="#{task.questions}" varStatus="questionsRepeat">
                        <h:panelGroup styleClass="question">
                          <h:panelGroup id="diff" layout="block" />
                          <script>
                            showDiff('form:tasks:#{tasksRepeat.index}:questions:#{questionsRepeat.index}:diff', '#{question.diff}');
                          </script>
                          <p style="font-weight: bold;">#{question.title}</p>
                          <p style="white-space: pre-wrap;">#{question.more}</p>
                          <p:selectOneButton value="#{question.answer}">
                            <f:selectItems value="#{question.options}"
                              var="option" itemLabel="#{option}"
                              itemValue="#{option}" />
                            <p:ajax onsuccess="PF('migrationPoller').start()"/>
                          </p:selectOneButton>
                        </h:panelGroup>
                      </p:repeat>
                    </h:panelGroup>
                  </div>
                </ui:repeat>
              </h:form>
            </h:panelGroup>
          </div>
        </div>
      </div>
      
      <p:dialog style="min-width: 300px;" header="Finish Migration Wizard" id="finishWizardModel"
        widgetVar="finishWizardModel" modal="true" responsive="true" closeOnEscape="true">
        <h:form id="finishWizardForm">
          <p:staticMessage severity="info" summary="Success" detail="To complete the migration, perform the follwing steps:" />
          <ol>
            <li>Restart your engine.</li>
            <li>If the engine starts in <b>Maintenance Mode</b>, use the <b>Setup Wizard</b> to finish your migration.<br />E.g install a new licence or migrate your System Database.</li>
          </ol>
          <br />
          
          <p:commandButton id="finishWizardYes" oncomplete="window.location = '/'" value="OK" icon="si si-check-1" 
            styleClass="modal-input-button" actionListener="#{systemDatabaseBean.saveConfiguration}" />
          <p:commandLink id="finishWizardNo" onclick="PF('finishWizardModel').hide();" value="Cancel" type="button"
            styleClass="modal-input-button" />
        </h:form>
      </p:dialog>
      
    </ui:define>
  </ui:composition>
</h:body>
</html>
