<html xmlns="http://www.w3.org/1999/xhtml"
  xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui"
  xmlns:pe="http://primefaces.org/ui/extensions"
  xmlns:cc="http://xmlns.jcp.org/jsf/composite/composite">
<h:body>
  <ui:composition template="../includes/template/wizard.xhtml">

    <ui:define name="content">
      <h:outputStylesheet name="resources/css/diff2html.css" />
      <h:outputScript name="resources/js/diff2html.min.js" />      
      <script>
      var diffOptions = {
        drawFileList: false,
        matching: 'words',
        outputFormat: 'side-by-side',
      }
      function showDiff(id, patch) {
        var diffHtml = Diff2Html.html(patch, diffOptions);
        document.getElementById(id).innerHTML = diffHtml;
      }
      </script>
      
      <div class="p-col card ui-fluid">
        <p:growl id="migrateGrowl" for="migrateGrowl" showDetail="true">
          <p:autoUpdate />
        </p:growl>
        <div class="p-d-flex p-ai-center p-mb-3">
          <i class="p-pr-3 si si-navigation-right-circle card-title-icon"></i>
          <h2 class="p-m-0">Migrate old Axon Ivy Engine</h2>
          <p:linkButton href="#{advisorBean.engineGuideBaseUrl}/reference/migration-wizard.html" target="_blank" rel="noopener noreferrer"
            styleClass="p-ml-auto ui-button-outlined rounded-button" icon="si si-question-circle" />
        </div>
        <h:form id="locationForm">
          <p:panelGrid columns="3" layout="flex" columnClasses="p-col-12 p-md-3 p-lg-3, p-col-12 p-md-6 p-lg-6, p-col-12 p-md-3 p-lg-3">
            <p:outputLabel for="oldEngineInput"
              value="Location of old Engine" />
            <h:panelGroup styleClass="md-inputfield">
              <p:inputText id="oldEngineInput"
                requiredMessage="Value is required"
                value="#{migrationBean.pathToOldEngine}"
                required="true" />
              <p:message for="oldEngineInput"
                id="oldEngineInputMessage" />
            </h:panelGroup>

            <p:commandButton icon="si si-heavy-equipment-hook"
              value="Load Location" id="checkLocation"
              actionListener="#{migrationBean.checkOldEngineLocation}"
              validateClient="true" update="migration, @form" />
          </p:panelGrid>
        </h:form>

        <h:panelGroup layout="block" id="migration">
          <h:form id="form" rendered="#{not empty migrationBean.migrationPath}">
            <p:panelGrid columns="2" layout="flex" columnClasses="p-col-12 p-md-9 p-lg-9, p-col-12 p-md-3 p-lg-3">
              <h3>Migrating: #{migrationBean.migrationPath}</h3>
              
              <h:panelGroup layout="block">
                <p:commandButton id="startMigration" icon="si si-controls-play" value="Start"
                  actionListener="#{migrationBean.execute}"
                  update="migration" onsuccess="PF('migrationPoller').start()"
                  rendered="#{migrationBean.state == 'START'}" />
                <p:commandButton id="finishMigration" icon="si si-check-1" value="Finish"
                  rendered="#{migrationBean.state == 'FINISHED'}" type="button"
                  onclick="PF('finishWizardModel').show();" />
                <p:commandButton id="migrationRunning" icon="si si-button-refresh-arrows si-is-spinning"
                  value="Running" disabled="true"
                  rendered="#{migrationBean.state == 'RUNNING'}" />
                <p:poll interval="1"
                  autoStart="#{migrationBean.state == 'RUNNING' and !migrationBean.runnerPaused}"
                  update="migration" widgetVar="migrationPoller" />
              </h:panelGroup>
            </p:panelGrid>
            <p:messages id="migrationMessage" for="migrationMessage" showDetail="true" closable="true" />
            <ui:repeat var="task" value="#{migrationBean.tasks}" id="tasks" varStatus="tasksRepeat">
              <div class="migration-step">
                <h4 class="p-mb-0 p-mt-3">
                  <i class="p-mr-0 si si-#{task.stateIcon} link-icon"></i> #{task.name}
                </h4>
                <p class="p-ml-5">#{task.description}</p>
                <h:panelGroup rendered="#{task.state == 'running'}" layout="block">
                  <p:repeat var="question" value="#{task.questions}" id="questions" varStatus="questionsRepeat">
                    <h:panelGroup styleClass="question">
                      <h:panelGroup id="diff" layout="block" />
                      <script>
                        showDiff('form:tasks:#{tasksRepeat.index}:questions:#{questionsRepeat.index}:diff', '#{question.diff}');
                      </script>
                      <p style="font-weight: bold;">#{question.title}</p>
                      <p style="white-space: pre-wrap;">#{question.more}</p>
                      <p:selectOneButton styleClass="migration-question-select-button" value="#{question.answer}">
                        <f:selectItems value="#{question.options}"
                          var="option" itemLabel="#{option}"
                          itemValue="#{option}" />
                        <p:ajax onsuccess="PF('migrationPoller').start()"/>
                      </p:selectOneButton>
                    </h:panelGroup>
                  </p:repeat>
                </h:panelGroup>
              </div>
            </ui:repeat>
          </h:form>
        </h:panelGroup>
      </div>
      
      <p:dialog style="min-width: 300px;" header="Finish Migration Wizard" id="finishWizardModel"
        widgetVar="finishWizardModel" modal="true" responsive="true" closeOnEscape="true">
        <h:form id="finishWizardForm" styleClass="custom-dialog-form">
          <div>  
            <p:staticMessage severity="info" summary="Success" detail="To complete the migration, perform the follwing steps:" />
            <ol>
              <li>Restart your engine.</li>
              <li>If the engine starts in <b>Maintenance Mode</b>, use the <b>Setup Wizard</b> to finish your migration.<br />E.g install a new licence.</li>
            </ol>
            <br />
          </div>
          <div class="custom-dialog-footer">
            <p:commandButton id="finishWizardNo" onclick="PF('finishWizardModel').hide();" value="Cancel" type="button"
              styleClass="ui-button-secondary ui-button-flat modal-input-button" />
            <p:commandButton id="finishWizardYes" oncomplete="window.location = '/'" value="OK" icon="si si-check-1" 
              styleClass="modal-input-button" rendered="#{not restartBean.restartable}"/>
            <p:commandButton id="finishWizardRestart" onclick="var button=this; buttonAddSpinner(button);" oncomplete="redirectToHomeAfterRestart()" 
              value="Restart" icon="si si-power-button" styleClass="modal-input-button" actionListener="#{restartBean.restart}" 
              rendered="#{restartBean.restartable}"/>              
          </div>
        </h:form>
      </p:dialog>
      
    </ui:define>
  </ui:composition>
</h:body>
</html>
