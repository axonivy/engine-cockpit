<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:ic="http://ivyteam.ch/jsf/component" xmlns:p="http://primefaces.org/ui"
  xmlns:pe="http://primefaces.org/ui/extensions" xmlns:cc="http://java.sun.com/jsf/composite/composite">
<h:body>
  <ui:composition template="../includes/template/template.xhtml">
  
    <ui:define name="head">
      <h:outputScript name="resources/codemirror/js/codemirror.min.js"/>
      <h:outputScript name="resources/codemirror/js/mode-yaml.min.js"/>
      <h:outputScript name="resources/codemirror/js/hint.min.js"/>
      <h:outputScript name="resources/codemirror/js/hint-yaml.js"/>
      <h:outputScript name="resources/codemirror/js/js-yaml.min.js"/>
      <h:outputScript name="resources/codemirror/js/lint.min.js"/>
      <h:outputScript name="resources/codemirror/js/lint-yaml.js"/>
      <h:outputStylesheet name="resources/codemirror/css/codemirror.min.css"/>
      <h:outputStylesheet name="resources/codemirror/css/hint.min.css"/>
      <h:outputStylesheet name="resources/codemirror/css/lint.min.css"/>
    </ui:define>
    
    <ui:define name="breadcrumb">
      <li>System</li>
      <li>/</li>
      <li><a href="editor.xhtml">Editor</a></li>
    </ui:define>
    
    <ui:define name="breadcrumb-right">
      <a href="#" onclick="window.open('#{advisorBean.cockpitEngineGuideUrl}'); return false;">
        <i class="material-icons">help</i>
      </a>
    </ui:define>
    
    <ui:define name="content">
      <cc:SingleCard id="card">
        <p:growl id="editorMessage" for="editorMessage" showDetail="true">
          <p:autoUpdate/>
        </p:growl>
        <script>
          var editors = [];
          function handleTabChange(index)
          {
            yamlHintDirectory = $('#card\\:editorTabView\\:' + index + '\\:editorForm\\:yamlhints').text().split(',');
            editors[index].refresh();
          }
        </script>
        <p:tabView id="editorTabView" styleClass="card tab-view-card editor-card" value="#{editorBean.configFiles}" var="config" widgetVar="editorTabView"
          onTabShow="handleTabChange(index)">
          <p:tab titleStyleClass="application-tab">
            <f:facet name="title">
               <i class="fa fa-pencil" />
               <h:outputText value="#{config.fileName}"/>
            </f:facet>
            <div class="ui-g">
              <div class="ui-g-12">
                <h:form id="editorForm">
                  <p:inputTextarea id="yamlhints" value="#{config.keys}" style="display: none"/>
                  <div id="editor_#{config.varName}" style="margin-bottom: 10px;"><p:inputTextarea id="content" value="#{config.content}" style="display: none"/></div>
                  <script>
                    var contentId_#{config.varName} = $("#editor_#{config.varName} textarea").attr('id');
                    
                    var editor_#{config.varName} = CodeMirror.fromTextArea(document.getElementById(contentId_#{config.varName}), {
                      lineNumbers: true,
                      mode: "text/x-yaml",
                      tabSize: 2,
                      showInvisibles: true,
                      gutters: ["CodeMirror-lint-markers"],
                      lint: true,
                      extraKeys: {
                        "Ctrl-Space": "autocomplete", Tab: function(cm) {
                          var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
                          cm.replaceSelection(spaces);
                        },
                        "Ctrl-S": function(instance) {
                          PF('saveEditor_#{config.varName}').jq.click();
                        }
                      }
                    });
                    editor_#{config.varName}.on("change", function (cm) {
                      document.getElementById(contentId_#{config.varName}).value = cm.getValue();
                    });
                    editors.push(editor_#{config.varName});
                    
                    function saveDirectlyOrOpenDialog_#{config.varName}() {
                      if (editor_#{config.varName}.state.lint.marked.length > 0) {
                        PF('saveEditorModel').show();
                      }
                      else {
                        PF('saveChanges').jq.click();
                      }
                    }
                  </script>
                  
                  <span style="color: grey; line-height: 30px;">
                    <i class="material-icons card-title-icon" style="font-size: 17px;">info</i>
                    <span>Tip: Use Ctrl+Space to get a list of known keywords</span>
                  </span>
                  <p:commandButton id="saveEditor" style="width: 150px; float: right; margin-left: 10px;" process="content" update="card:saveEditorModel"
                    value="Save" icon="ui-icon-save" actionListener="#{editorBean.setActiveConfigFile(config)}" 
                    oncomplete="saveDirectlyOrOpenDialog_#{config.varName}();" widgetVar="saveEditor_#{config.varName}"/>
                  <p:commandLink id="cancelEditor" onclick="window.location.reload(true)" value="Cancel" type="button"
                    style="float: right; line-height: 30px;"/>
                </h:form>
              </div>
            </div>
          </p:tab>
        </p:tabView>
        
        <p:dialog style="min-width: 300px;" header="Save #{editorBean.activeConfigFile.fileName}" id="saveEditorModel"
          widgetVar="saveEditorModel" modal="true" responsive="true" closeOnEscape="true" styleClass="dashboard-card">
          <h:form id="saveEditorForm">
            <p:staticMessage severity="info" summary="Yaml errors are detected. Do you want to save anyway?" style="margin-bottom: 10px;"/>
            
            <p:commandButton id="saveChangesBtn" onclick="PF('saveEditorModel').hide();"
              actionListener="#{editorBean.activeConfigFile.save()}" value="Save" icon="ui-icon-save"
              styleClass="modal-input-button" widgetVar="saveChanges" />
            <p:commandLink id="cancelChangesBtn" onclick="PF('saveEditorModel').hide();" value="Cancel" type="button"
              styleClass="modal-input-button" />
          </h:form>
        </p:dialog>
      </cc:SingleCard>
    </ui:define>
  </ui:composition>
</h:body>
</html>