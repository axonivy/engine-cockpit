<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:cc="http://xmlns.jcp.org/jsf/composite"
	xmlns:ic="http://ivyteam.ch/jsf/component"
	xmlns:p="http://primefaces.org/ui">
<cc:interface>
	<cc:attribute name="title" default="Renew Licence" />
</cc:interface>
<cc:implementation>
	<p:dialog style="margin-left: 120px;" header="#{cc.attrs.title}"
		id="renewLicence" width="35%" widgetVar="renewLicence" modal="true"
		responsive="true" closeOnEscape="true" styleClass="ui-fluid">
		<form> 
			<p:outputLabel value="Where do you want to send the Licence to?" />
			<p:panelGrid columns="2" layout="grid" styleClass="ui-panelgrid-blank">
				<p:inputText value="" type="email" placeholder="E-Mail"
					required="true" requiredMessage="Put Email" style="width: 120%"/>
				<p:commandButton value="Send" style="width: 50%; margin-left: 40%"
					onclick="sendRenewLicence(); PF('renewLicence').hide()"/>
			 </p:panelGrid>
			 <p:growl widgetVar="responseGrowl" showDetail="true" sticky="true"/>
		</form>
		<script>
		function sendRenewLicence(){
			var content = `#{licenceBean.licenceContent}`;

			var file = new File([content], "test.lic");

			var form = new FormData();
			form.append("oldLicense", file);
						
			var settings = {
			  "async": true,
			  "crossDomain": true,
			  "url": "http://"+window.location.hostname+":"+window.location.port+"/ivy/api/designer/renewLicense",
			  "method": "PUT",
			  "headers": {"X-Requested-By": "ivy" },
			  "processData": false,
			  "contentType": false,
			  "mimeType": "multipart/form-data",
			  "data": form,
			  success: function(data, textStatus, xhr){
				  console.log("this is success: "+xhr.status);
				  if (xhr.status == 200){
				  	createGrowl("Your request has been sent.", "info");
                  }
			  },
			  fail: function(xhr,textStatus, errorThrown){
			  	console.log("this is fail: "+xhr.status);
			  	createGrowl("There was some problem with your request. Status code is: "+xhr.status, "warn");
			  },
			  complete: function(xhr, textStatus){
				  console.log("this is complete: "+xhr.status);
				  if(xhr.status == 406){
				  	createGrowl("Your request already exists","error");
				  }
			  }
			}
			
			function createGrowl(detail, severity){
				PF('responseGrowl').renderMessage({
					"summary":"Message",
                    "detail": detail,
                    "severity":severity});
			}
			
			$.ajax(settings).done(function (response) {
			  console.log(response);
			});
		}
		</script>
	</p:dialog>
</cc:implementation>
</html>
