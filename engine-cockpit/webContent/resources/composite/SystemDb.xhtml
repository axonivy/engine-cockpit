<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:cc="http://xmlns.jcp.org/jsf/composite" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui">
<cc:interface>
  <cc:attribute name="updateFields" default="#{cc.attrs.updateFields}" />
</cc:interface>

<cc:implementation>
  <h:form id="systemDbForm">
    <div class="ui-g">
      <div class="ui-g-12">
        <p:outputPanel id="connectionPanel" styleClass="connection-panel">
          <div class="ui-message ui-staticmessage #{systemDatabaseBean.connectionInfo.messageLevel} ui-widget ui-corner-all">
            <i class="#{systemDatabaseBean.connectionInfo.icon}" />
            <span class="ui-message-error-summary">#{systemDatabaseBean.connectionInfo.label}</span>
            <span class="ui-message-error-detail">#{systemDatabaseBean.connectionInfo.advise}</span>
          </div>
          
          <div>
            <p:commandButton value="Check Connection" id="checkConnectionButton" styleClass="wizard-top-button secondary-btn"
              icon="ui-icon-check" update="connectionPanel" actionListener="#{systemDatabaseBean.testConnection()}" />
            <p:commandButton value="Create Database" id="createDatabaseButton" icon="ui-icon-dns" styleClass="wizard-top-button secondary-btn" 
              type="button" onclick="PF('createDatabaseDialog').show();" disabled="#{!systemDatabaseBean.connectionInfo.mustCreate}" />
            <p:commandButton value="Migrate Database" id="migrateDatabaseButton" icon="ui-icon-autorenew" styleClass="wizard-top-button secondary-btn"
              actionListener="#{systemDatabaseBean.createConverter()}" update="systemDb:convertDatabaseDialog" 
              onsuccess="PF('convertDatabaseDialog').show();" disabled="#{!systemDatabaseBean.connectionInfo.mustConvert}" />
          </div>
        </p:outputPanel>
      </div>
  
      <div class="ui-g-12">
        <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9" 
          styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
          <p:outputLabel for="databaseType" value="Database" />
          <p:selectOneMenu id="databaseType" value="#{systemDatabaseBean.product}">
            <f:selectItems value="#{systemDatabaseBean.supporedDatabaseNames}" var="database" itemLabel="#{database}" itemValue="#{database}" />
            <p:ajax update="#{cc.attrs.updateFields},@form:databaseDriver,@form:dynamicForm" process="@this" listener="#{systemDatabaseBean.configChanged}" />
          </p:selectOneMenu>
    
          <p:outputLabel for="databaseDriver" value="Driver" />
          <p:selectOneMenu id="databaseDriver" value="#{systemDatabaseBean.driver}">
            <f:selectItems value="#{systemDatabaseBean.supportedDriverNames}" var="driver" itemLabel="#{driver}" itemValue="#{driver}" />
            <p:ajax update="#{cc.attrs.updateFields},@form:dynamicForm" process="@this" listener="#{systemDatabaseBean.configChanged}" />
          </p:selectOneMenu>
        </p:panelGrid>
        
        <h:panelGroup id="dynamicForm">
          <p:repeat var="connProp" value="#{systemDatabaseBean.connectionProperties}">
            <ui:fragment rendered="#{connProp.number}">
              <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9"
                styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
                <p:outputLabel for="numberProp" value="#{connProp.label}" />
                <h:panelGroup>
                  <p:inputNumber styleClass="#{connProp.cssClass}" id="numberProp" 
                    value="#{connProp.value}" required="#{connProp.required}" disabled="#{connProp.defaultValue}"
                    thousandSeparator="'" decimalPlaces="0" minValue="0" style="width: calc(100% - 105px); display: inline-block;">
                    <p:ajax event="keyup" update="#{cc.attrs.updateFields}" listener="#{systemDatabaseBean.configChanged}" />
                  </p:inputNumber>
                  <p:selectBooleanCheckbox id="defaultConnectionProperty" style="margin: 0; float: right;"
                    itemLabel="Default" value="#{connProp.defaultValue}" styleClass="#{connProp.cssClass}-default-checkbox">
                    <p:ajax process="@this" update="@parent:numberProp" />
                  </p:selectBooleanCheckbox>
                </h:panelGroup>
              </p:panelGrid>
            </ui:fragment>
              
            <ui:fragment rendered="#{connProp.password}">
              <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9"
                styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
                <p:outputLabel for="passwordProperty" value="#{connProp.label}" />
                <h:panelGroup styleClass="md-inputfield">
                  <p:password styleClass="#{connProp.cssClass}" id="passwordProperty" 
                    value="#{connProp.value}" required="#{connProp.required}" redisplay="true" autocomplete="new-password">
                    <p:ajax event="keyup" update="#{cc.attrs.updateFields},@parent:passwordPropertyMessage" listener="#{systemDatabaseBean.configChanged}" />
                  </p:password>
                  <p:message for="passwordProperty" id="passwordPropertyMessage" />
                </h:panelGroup>
              </p:panelGrid>
            </ui:fragment>
              
            <ui:fragment rendered="#{connProp.input}">
              <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9"
                styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
                <p:outputLabel for="inputProperty" value="#{connProp.label}" />
                <h:panelGroup styleClass="md-inputfield">
                  <p:inputText styleClass="#{connProp.cssClass}" id="inputProperty" 
                    value="#{connProp.value}" required="#{connProp.required}" autocomplete="off">
                    <p:ajax event="keyup" update="#{cc.attrs.updateFields},@parent:inputPropertyMessage" listener="#{systemDatabaseBean.configChanged}" />
                  </p:inputText>
                  <p:message for="inputProperty" id="inputPropertyMessage" />
                </h:panelGroup>
              </p:panelGrid>
            </ui:fragment>
          </p:repeat>
        </h:panelGroup>
        
        <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9" 
          styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
          <label>Additional Properties</label>
          <h:panelGroup>
            <p:dataTable var="property" value="#{systemDatabaseBean.additionalProperties}" id="additionalPropertiesTable"
              styleClass="no-header-table">
              <p:column>
                <h:outputText value="#{property.key}" styleClass="property_key" />
              </p:column>
              <p:column>
                <h:outputText value="#{property.value}" />
              </p:column>
              <p:column style="width: 40px;">
                <p:commandButton id="removeAdditionalProperty" actionListener="#{systemDatabaseBean.removeProp(property.key)}" update="@form:additionalPropertiesTable"
                  icon="ui-icon-delete" title="Delete" styleClass="card-button table-control-btn red-btn" style="margin: 0;" process="@this" />
              </p:column>
            </p:dataTable>
            <p:commandButton id="newAdditionalPropertyBtn" actionListener="#{systemDatabaseBean.addProp()}"
              icon="ui-icon-plus" title="Add Property" update="systemDb:addAdditionalPropertyDialog" value="Add Property"
              styleClass="secondary-btn" oncomplete="PF('addAdditionalPropertyDialog').show();" process="@this" 
              style="float: right; width: 150px; margin-top: 5px;"/>
          </h:panelGroup>
        </p:panelGrid>
      </div>
    </div>
  </h:form>
  
  <p:dialog id="createDatabaseDialog" widgetVar="createDatabaseDialog"
    header="Create System Database" modal="true" closeOnEscape="true">
    <h:form id="createDatabaseForm">
      <h:outputText value="Enter the required parameters for your System Database configuration:" />
      <br />
      <br />
      <p:repeat var="para" value="#{systemDatabaseBean.creationParams}">
        <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9"
          styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
          <p:outputLabel for="creationParam" value="#{para.label}" />
          <h:panelGroup styleClass="md-inputfield">
            <p:inputText id="creationParam" value="#{para.value}" required="true"
              disabled="#{para.label.equalsIgnoreCase('enginetype')}" />
            <p:message for="creationParam" id="creationParamMessage" />
          </h:panelGroup>
        </p:panelGrid>
      </p:repeat>
      
      <div style="margin-bottom: 20px;">
        <p:poll autoStart="#{systemDatabaseBean.dbCreatorRunning}" id="convertingOutputPoll"
          widgetVar="convertingOutputPoll"
          update="@form" interval="2" />
      
        <h:outputText rendered="#{systemDatabaseBean.dbCreatorRunning}">
          <i class="fa fa-circle-o-notch fa-spin ajax-loader" aria-hidden="true" />
        </h:outputText>
        <h:outputText id="creationResult" value="#{systemDatabaseBean.dbCreatorText}" />
      </div>
      
      <p:commandButton value="Create" actionListener="#{systemDatabaseBean.createDatabase}" icon="ui-icon-dns"
        styleClass="primary-btn modal-input-button" update="@form" id="dialogCreateDbButton" />
      <p:commandButton value="Cancel" icon="ui-icon-clear"
        styleClass="secondary-btn modal-input-button"
        oncomplete="PF('createDatabaseDialog').hide();" />
    </h:form>
  </p:dialog>
  
  <p:dialog id="convertDatabaseDialog" widgetVar="convertDatabaseDialog"
    header="Do you really want to convert?" dynamic="true" modal="true"
    closeOnEscape="true">
    <h:form id="convertDatabaseForm">
      <p:poll autoStart="#{systemDatabaseBean.dbConversionRunning}" id="convertingOutputPoll"
        widgetVar="convertingOutputPoll"
        update="@form" interval="2" />
      <p:panelGrid columns="1" layout="grid" 
        styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
        <h:outputText rendered="#{systemDatabaseBean.dbConversionRunning}">
          <i class="fa fa-circle-o-notch fa-spin ajax-loader" aria-hidden="true" />
        </h:outputText>
        <h:outputText id="conversionResult" value="#{systemDatabaseBean.dbConversionError}" />
        <h:outputText rendered="#{systemDatabaseBean.dbConversionFinished}" 
          value="The database was migrated successfully. Please check the connection!" />
      </p:panelGrid>
      
      <h:panelGroup rendered="#{!systemDatabaseBean.dbConversionFinished}">
        <p:commandButton id="confirmConvertButton" value="Convert" disabled="#{systemDatabaseBean.dbConversionRunning}"
          icon="ui-icon-autorenew" actionListener="#{systemDatabaseBean.convertDatabase}"
          update="@form" styleClass="primary-btn modal-input-button" />
        <p:commandButton value="Cancel" icon="ui-icon-clear" disabled="#{systemDatabaseBean.dbConversionRunning}"
          styleClass="secondary-btn modal-input-button"
          oncomplete="PF('convertDatabaseDialog').hide();" />
      </h:panelGroup>
      <h:panelGroup rendered="#{systemDatabaseBean.dbConversionFinished}">
        <p:commandButton id="closeConversionButton" value="Connect"
          icon="ui-icon-check" actionListener="#{systemDatabaseBean.testConnection}"
          onclick="PF('convertDatabaseDialog').hide();"
          update="systemDb:systemDbForm:connectionPanel" styleClass="primary-btn modal-input-button" />
      </h:panelGroup>
    </h:form>
  </p:dialog>
  
  <p:dialog widgetVar="addAdditionalPropertyDialog" id="addAdditionalPropertyDialog"
    header="Additional property" modal="true" closeOnEscape="true"
    focus="addAdditionalPropertyForm:key">
    <h:form id="addAdditionalPropertyForm">
      <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9" 
        styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
        <p:outputLabel for="key" value="Key" />
        <h:panelGroup styleClass="md-inputfield">
          <p:inputText id="key" requiredMessage="Value is required" disabled="#{not empty systemDatabaseBean.propKey}"
            value="#{systemDatabaseBean.propKey}" required="true" />
          <p:message for="key" id="keyMessage" />
        </h:panelGroup>
        
        <p:outputLabel for="value" value="Value" />
        <h:panelGroup styleClass="md-inputfield">
          <p:inputText id="value" requiredMessage="Value is required"
            value="#{systemDatabaseBean.propValue}" required="true" />
          <p:message for="value" id="valueMessage" />
        </h:panelGroup>
      </p:panelGrid>
      <p:commandButton id="saveProperty" validateClient="true" update="@form,systemDb:systemDbForm:additionalPropertiesTable"
        actionListener="#{systemDatabaseBean.saveProp()}" value="Save" icon="ui-icon-save"
        styleClass="primary-btn modal-input-button" oncomplete="if (!args.validationFailed) PF('addAdditionalPropertyDialog').hide();" />
      <p:commandButton id="cancelEditAdmin" onclick="PF('addAdditionalPropertyDialog').hide();" value="Cancel" type="button"
        icon="ui-icon-clear" styleClass="secondary-btn modal-input-button" />
    </h:form>
  </p:dialog>
</cc:implementation>
</html>
