<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:cc="http://xmlns.jcp.org/jsf/composite" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui">
<cc:implementation>
  <h:form id="systemDbForm">
    <div class="ui-g">
      <div class="ui-g-12">
        <p:outputPanel id="connectionPanel" styleClass="connection-panel">
          <div class="ui-message ui-staticmessage #{systemDatabaseBean.connectionInfo.messageLevel} ui-widget ui-corner-all">
            <i class="#{systemDatabaseBean.connectionInfo.icon}" />
            <span class="ui-message-error-summary">#{systemDatabaseBean.connectionInfo.label}</span>
            <span class="ui-message-error-detail">#{systemDatabaseBean.connectionInfo.advise}</span>
          </div>
          
          <div>
            <p:commandButton value="Check Connection" id="checkConnectionButton" styleClass="wizard-top-button secondary-btn"
              icon="ui-icon-check" update="connectionPanel" actionListener="#{systemDatabaseBean.testConnection()}" />
            <p:commandButton value="Create Database" id="createDatabaseButton" icon="ui-icon-dns" styleClass="wizard-top-button secondary-btn" 
              type="button" onclick="PF('createDatabaseDialog').show();" disabled="#{!systemDatabaseBean.connectionInfo.mustCreate}" />
            <p:commandButton value="Migrate Database" id="migrateDatabaseButton" icon="ui-icon-autorenew" styleClass="wizard-top-button secondary-btn"
              type="button" onclick="PF('convertDatabaseDialog').show();" disabled="#{!systemDatabaseBean.connectionInfo.mustConvert}" />
          </div>
        </p:outputPanel>
      </div>
  
      <div class="ui-g-12">
        <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9" 
          styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
          <p:outputLabel for="databaseType" value="Database" />
          <p:selectOneMenu id="databaseType" value="#{systemDatabaseBean.product}">
            <f:selectItems value="#{systemDatabaseBean.supporedDatabaseNames}" var="database" itemLabel="#{database}" itemValue="#{database}" />
            <p:ajax update="@form" process="@this" />
          </p:selectOneMenu>
    
          <p:outputLabel for="databaseDriver" value="Driver" />
          <p:selectOneMenu id="databaseDriver" value="#{systemDatabaseBean.driver}">
            <f:selectItems value="#{systemDatabaseBean.supportedDriverNames}" var="driver" itemLabel="#{driver}" itemValue="#{driver}" />
            <p:ajax update="@form" process="@this" />
          </p:selectOneMenu>
        </p:panelGrid>
        
        <p:repeat var="connProp" value="#{systemDatabaseBean.connectionProperties}">
          <ui:fragment rendered="#{connProp.number}">
            <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9"
              styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
              <p:outputLabel for="numberProp" value="#{connProp.label}" />
              <h:panelGroup>
                <p:inputNumber id="numberProp" value="#{connProp.value}" required="#{connProp.required}" disabled="#{connProp.defaultValue}"
                  thousandSeparator="'" decimalPlaces="0" minValue="0" style="width: calc(100% - 105px); display: inline-block;">
                  <p:ajax event="keyup" update="@form:connectionPanel" />
                </p:inputNumber>
                <p:selectBooleanCheckbox id="defaultConnectionProperty" style="margin: 0; float: right;"
                  itemLabel="Default" value="#{connProp.defaultValue}" >
                  <p:ajax process="@this" update="@parent:numberProp" />
                </p:selectBooleanCheckbox>
              </h:panelGroup>
            </p:panelGrid>
          </ui:fragment>
            
          <ui:fragment rendered="#{connProp.password}">
            <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9"
              styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
              <p:outputLabel for="passwordProperty" value="#{connProp.label}" />
              <h:panelGroup styleClass="md-inputfield">
                <p:password id="passwordProperty" value="#{connProp.value}" required="#{connProp.required}" redisplay="true" autocomplete="new-password">
                  <p:ajax event="keyup" update="@form:connectionPanel,@parent:passwordPropertyMessage" />
                </p:password>
                <p:message for="passwordProperty" id="passwordPropertyMessage" />
              </h:panelGroup>
            </p:panelGrid>
          </ui:fragment>
            
          <ui:fragment rendered="#{connProp.input}">
            <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9"
              styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
              <p:outputLabel for="inputProperty" value="#{connProp.label}" />
              <h:panelGroup styleClass="md-inputfield">
                <p:inputText id="inputProperty" value="#{connProp.value}" required="#{connProp.required}" autocomplete="off">
                  <p:ajax event="keyup" update="@form:connectionPanel,@parent:inputPropertyMessage" />
                </p:inputText>
                <p:message for="inputProperty" id="inputPropertyMessage" />
              </h:panelGroup>
              </p:panelGrid>
          </ui:fragment>
        </p:repeat>
        
        <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9" 
          styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
          <label>Additional Properties</label>
          <h:panelGroup>
            <p:dataTable var="property" value="#{systemDatabaseBean.additionalProperties}" id="additionalPropertiesTable"
              styleClass="no-header-table">
              <p:column>
                <h:outputText value="#{property.key}" styleClass="property_key" />
              </p:column>
              <p:column>
                <h:outputText value="#{property.value}" />
              </p:column>
              <p:column style="width: 40px;">
                <p:commandButton id="removeAdditionalProperty" actionListener="#{systemDatabaseBean.removeProp(property.key)}" update="@form:additionalPropertiesTable"
                  icon="ui-icon-delete" title="Delete" styleClass="card-button table-control-btn red-btn" style="margin: 0;" process="@this" />
              </p:column>
            </p:dataTable>
            <p:commandButton id="newAdditionalPropertyBtn" actionListener="#{systemDatabaseBean.addProp()}"
              icon="ui-icon-plus" title="Add Property" update="systemDb:addAdditionalPropertyDialog" value="Add Property"
              styleClass="secondary-btn" oncomplete="PF('addAdditionalPropertyDialog').show();" process="@this" 
              style="float: right; width: 150px; margin-top: 5px;"/>
          </h:panelGroup>
        </p:panelGrid>
      </div>
    </div>
  </h:form>
  
  <p:dialog id="createDatabaseDialog" widgetVar="createDatabaseDialog"
    header="Create System Database" modal="true" closeOnEscape="true">
    <!-- <h:form id="createDatabaseForm">
      <h:outputText
        value="Enter the required parameters for your System Database configuration:" />
      <br />
      <br />
      <p:panelGrid>
        <ui:repeat var="parameter" value="#{data.requiredParameters}"
          varStatus="status" id="uiRepeat">
          <p:row>
            <p:column>
              <p:outputLabel for="creationParam"
                value="#{ivy.cms.co('/com.axonivy.engineconfig.ui/creationParameters/' += parameter.name)}" />
            </p:column>
            <p:column>
              <p:inputText
                value="#{data.configData.creationParameters[parameter.name]}"
                id="creationParam"
                disabled="#{parameter.name.equalsIgnoreCase('enginetype')}"
                required="true" />
            </p:column>
          </p:row>
        </ui:repeat>
      </p:panelGrid>
      <br />
      <p:commandButton value="Create Database"
        actionListener="#{logic.createDatabase}"
        update="createDatabaseForm, :#{cc.clientId}:creatingDatabaseForm:doUpdate"
        oncomplete="if (args &amp;&amp; !args.validationFailed) {PF('createDatabaseDialog').hide(); PF('creatingDatabaseDialog').show();}"
        id="dialogCreateDbButton" />
      <p:defaultCommand target="dialogCreateDbButton" />
    </h:form> -->
  </p:dialog>
  
  <p:dialog id="convertDatabaseDialog" widgetVar="convertDatabaseDialog"
    header="Do you really want to convert?" dynamic="true" modal="true"
    closeOnEscape="true">
    <h:form id="convertDatabaseForm">
      <div style="margin-bottom: 20px;">
        <p:poll autoStart="#{systemDatabaseBean.dbConversionRunning}" id="convertingOutputPoll"
          widgetVar="convertingOutputPoll"
          update="@form" interval="1" />
      
        <h:outputText rendered="#{systemDatabaseBean.dbConversionRunning}">
          <i class="fa fa-circle-o-notch fa-spin ajax-loader" aria-hidden="true" />
        </h:outputText>
        <h:outputText value="#{systemDatabaseBean.dbConversionText}" />
      </div>
      
      <p:commandButton id="confirmConvertButton" value="Yes"
        icon="ui-icon-check" actionListener="#{systemDatabaseBean.convertDatabase}"
        update="@form" styleClass="primary-btn modal-input-button" />
      <p:commandButton value="Cancel" icon="ui-icon-clear"
        styleClass="secondary-btn modal-input-button"
        oncomplete="PF('convertDatabaseDialog').hide();" />
      <p:defaultCommand target="confirmConvertButton" />
    </h:form>
  </p:dialog>
  
  <p:dialog widgetVar="addAdditionalPropertyDialog" id="addAdditionalPropertyDialog"
    header="Additional property" modal="true" closeOnEscape="true"
    focus="addAdditionalPropertyForm:key">
    <h:form id="addAdditionalPropertyForm">
      <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9" 
        styleClass="ui-panelgrid-blank form-group modal-input-form grey-label-panel ui-fluid">
        <p:outputLabel for="key" value="Key" />
        <h:panelGroup styleClass="md-inputfield">
          <p:inputText id="key" requiredMessage="Value is required" disabled="#{not empty systemDatabaseBean.propKey}"
            value="#{systemDatabaseBean.propKey}" required="true" />
          <p:message for="key" id="keyMessage" />
        </h:panelGroup>
        
        <p:outputLabel for="value" value="Value" />
        <h:panelGroup styleClass="md-inputfield">
          <p:inputText id="value" requiredMessage="Value is required"
            value="#{systemDatabaseBean.propValue}" required="true" />
          <p:message for="value" id="valueMessage" />
        </h:panelGroup>
      </p:panelGrid>
      <p:commandButton id="saveProperty" validateClient="true" update="@form,systemDb:systemDbForm:additionalPropertiesTable"
        actionListener="#{systemDatabaseBean.saveProp()}" value="Save" icon="ui-icon-save"
        styleClass="primary-btn modal-input-button" oncomplete="if (!args.validationFailed) PF('addAdditionalPropertyDialog').hide();" />
      <p:commandButton id="cancelEditAdmin" onclick="PF('addAdditionalPropertyDialog').hide();" value="Cancel" type="button"
        icon="ui-icon-clear" styleClass="secondary-btn modal-input-button" />
    </h:form>
  </p:dialog>
</cc:implementation>
</html>
